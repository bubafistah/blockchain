stages:
  - base
  - depends
  - build
  - deploy

Docker Hub:
  stage: deploy
  image: docker
  services:
    - name: docker:dind
      command: [ "--experimental" ]
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - docker pull $CI_REGISTRY_IMAGE
    - docker push "lthn/chain"
  environment:
    name: docker.io
  only:
    - main

b:base:
  stage: base
  image: docker
  interruptible: true
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
    DOCKER_BUILDKIT: 1
  services:
    - name: docker:dind
      command: [ "--experimental" ]
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - docker build --pull --build-arg THREADS=1 --build-arg BUILDKIT_INLINE_CACHE=1 --cache-from $CI_REGISTRY_IMAGE -t $CI_REGISTRY_IMAGE --target=base -f Dockerfile .
    - docker push "$CI_REGISTRY_IMAGE"

b:depends:
  stage: depends
  image: docker
  interruptible: true
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
    DOCKER_BUILDKIT: 1
  parallel:
    matrix:
      - TARGET: windows
      - TARGET: linux
      - TARGET: macos
  services:
    - name: docker:dind
      command: [ "--experimental" ]
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - docker pull "$CI_REGISTRY_IMAGE:depends-${TARGET}" || true
    - docker build --pull --build-arg THREADS=1 --build-arg BUILDKIT_INLINE_CACHE=1 --cache-from $CI_REGISTRY_IMAGE:depends-${TARGET} -t $CI_REGISTRY_IMAGE:depends-${TARGET} --target=depends-${TARGET} -f Dockerfile .
    - docker push "$CI_REGISTRY_IMAGE:depends-${TARGET}"

b:build:
  stage: build
  image: docker
  interruptible: true
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
    DOCKER_BUILDKIT: 1
  parallel:
    matrix:
      - TARGET: windows
      - TARGET: linux
      - TARGET: macos
  services:
    - name: docker:dind
      command: [ "--experimental" ]
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - docker pull "$CI_REGISTRY_IMAGE:depends-${TARGET}" || true
    - docker build -o /artifacts --pull --build-arg THREADS=1 --build-arg BUILDKIT_INLINE_CACHE=1 --cache-from $CI_REGISTRY_IMAGE:depends-${TARGET} -t $CI_REGISTRY_IMAGE:${TARGET} --target=final-${TARGET} -f Dockerfile .
    - docker push "$CI_REGISTRY_IMAGE:${TARGET}"
  artifacts:
    name: ${TARGET}
    paths:
      - /artifacts


